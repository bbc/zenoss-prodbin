#! /usr/bin/env bash
##############################################################################
# 
# Copyright (C) Zenoss, Inc. 2014, all rights reserved.
# 
# This content is made available according to terms specified in
# License.zenoss under the directory where your Zenoss product is installed.
# 
##############################################################################


# This script runs custom commands passed in to the container from the host.
#
# Return codes:
#     0 - OK            No action required by the host
#   100 - TXCOMMIT      Host to commit container into the image
# Error Codes:   
#    -1 - BADPARAM      Bad params
#    -2 - NOTFOUND      Script not found
#    -3 - INVALID       Invalid script
#
# Each script follows a specific design template.
#
# Example:
#   #! /bin/bash
#
#   # Default action for undefined program calls
#   __DEFAULT__() {
#       /bin/helloworld $@
#       return 0
#   }
#
#   # ---
#   # Transaction-based commands
#   # ---
#
#   # Usage: zenrun /bin/helloworld savestate
#   savestate() {
#       /bin/helloworld $@
#       if test $? -eq 0; then
#           return 100
#       fi
#
#       return 0
#   }


# Parse the arguments
# Usage: zenrun PROGRAM [ARGS]
if test $# -lt 2; then
    echo -e "Missing program argument" >&2
    exit -1
fi

PROGRAM=$1
shift; ARGS=$@

# Load the program
if ls $PROGRAM > /dev/null; then
    source $PROGRAM
else
    echo -e "Program not found: $PROGRAM" >&2
    exit -2
fi

# Look up the command and run
if declare -f $ARGS[0] > /dev/null; then
    $ARGS
else if declare -f "__DEFAULT__" > /dev/null; then
    __DEFAULT__ $ARGS
else
    echo -e "Missing __DEFAULT__ declaration in $PROGRAM" >&2
    exit -3
fi

exit $?
